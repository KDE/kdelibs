<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Guide to Porting Applications to KDE Frameworks 5</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
<!--
body {
    font-size: 0.8em;
    font-family: "Bitstream Vera Sans", "Lucida Grande", "Trebuchet MS", sans-serif;
    color: #535353;
    background-color: #ffffff;
}

h1, h2, h3, h4, h5 {
    font-weight: bold;
    color: #f7800a;
}

a:link {
    padding-bottom: 0;
    text-decoration: none;
    color: #0057ae;
}

a:visited {
    padding-bottom: 0;
    text-decoration: none;
    color: #644A9B;
}

a[href]:hover {
    text-decoration: underline;
}

pre {
    display: block;
    margin: 0.3em;
    padding: 0.3em;
    font-size: 1em;
    font-family: Courier, 'Courier New', 'Andale Mono', Monaco, monospace;
    color: #000000;
    background: #f9f9f9;
    border: #2f6fab dashed;
    border-width: 1px;
    overflow: auto;
    line-height: 1.1em;
}
-->
</style>
</head>
<body>
<h1>Porting Applications to KDE Frameworks 5</h1>

<h2>Note</h2>

<p>This document contains the changes you have to apply to programs written for
KDE 4.x when you want to port them to KDE Frameworks 5.<br>

<h3><a name="TOC">Table of Contents</a></h3>

<UL>
<li><a href="#globalchanges">Global Changes</a></li>
<li><a href="#kdecore">Changes in kdecore</a></li>
<li><a href="#kdeui">Changes in kdeui</a></li>
<li><a href="#kio">Changes in kio</a></li>
<li><a href="#kparts">Changes in kparts</a></li>
</UL>

<h3><a name="globalchanges">Global Changes</a></h3>
<ul>
</ul>

<h4 align="right"><a href="#TOC">Return to the Table of Contents</a></h4>


<h3><a name="kdecore">Changes in kdecore</a></h3>

<ul>
<li>kdecore has been split up into a number of independent libraries: libkarchive, libkauth, libkdbus, etc.</li>
<li>KUrl has been deprecated in favour of QUrl. Warning, look at the KUrl documentation for proper porting.
Do not just do a global search and replace, KUrl(QString) means "absolute local file or absolute url" while
QUrl(QString) means "relative url or absolute url".
<li>For the reason above, many signals with a KUrl have been replaced with a QUrl:
<pre>
    KUrlRequester: urlSelected(const KUrl&amp;) &gt; urlSelected(const QUrl&amp;)
    KRecentFilesAction: urlSelected(const KUrl&amp;) &gt; urlSelected(const QUrl&amp;)
    KUrlComboBox: urlActivated(const KUrl&amp;) &gt; urlActivated(const QUrl&amp;)
    KPropertiesDialog: saveAs(KUrl,KUrl) &gt; saveAs(QUrl,QUrl)
</pre>
Remember to update your connect statements and your slots!
<li>KMimeType::comment and KMimeType::iconName no longer take a KUrl argument. If you were passing such an argument
(to support .directory files in directories), port the code to KFileItem::mimeComment and KFileItem::iconName.</li>
<li>KSaveFile has been deprecated in favour of the new QSaveFile:
<pre>
     open() -&gt; open(QIODevice::WriteOnly)
     finalize() -&gt; commit()
     abort() -&gt; cancelWriting()
     close() -&gt; do not call close, call commit or cancelWriting directly
     the return value from write() calls does not need to be checked anymore, commit will cancel in case of a write error.
</pre>
<li>KStandardDirs: KDE applications can keep using it, but independent frameworks should use QStandardPaths instead.
The porting depends on the resource type:
<pre>
    KStandardDirs "data" -&gt; QStandardPaths::GenericDataLocation
    KStandardDirs "appdata" -&gt; QStandardPaths::DataLocation
    KStandardDirs "config" -&gt; QStandardPaths::ConfigLocation
    KStandardDirs "xdgdata-apps" -&gt; QStandardPaths::ApplicationsLocation
</pre>
If the resource is available in QStandardPaths (i.e. for all of the above), then the porting is simple:
<pre>
    KStandardDirs::locate("data", "kmyapp/my-data") -&gt; QStandardPaths::locate(QStandardPaths::GenericDataLocation, "kmyapp/my-data")
    saveLocation -&gt; writableLocation (note that you might have to mkpath it if it doesn't exist)
    locateLocal(type, file) -&gt; writableLocation(type) + '/' + file (you might have to mkpath the directory)
    resourceDirs("xdgdata-apps") -&gt; QStandardPaths::standardLocations(QStandardPaths::ApplicationsLocation)  (no trailing slashes anymore though)
</pre>
Otherwise, you need to use GenericDataLocation and add the subdirectory name manually.
<pre>
    dirs()-&gt;resourceDirs("xdgdata-icon") -&gt; QStandardPaths::locateAll(QStandardPaths::GenericDataLocation, "icons", QStandardPaths::LocateDirectory) // xdgata-icon is the "icons" subdir under the xdg data locations
    dirs()-&gt;findAllResources("xdgdata-mime", file) -&gt; QStandardPaths::locateAll(QStandardPaths::GenericDataLocation, "mime/" + file)
    dirs()-&gt;findAllResources("xdgdata-mime", "foo/*.txt") -&gt; QStandardPaths::standardLocations(QStandardPaths::GenericDataLocation) + foreach + entryList, prepending the absolute path.
</pre>
When the code uses wildcard filters or the Recursive flag in findAllResources, you cannot port it to one line of QStandardPaths.
Either keep using KStandardDirs, or write your own filtering (easy) or recursive listing (not as easy).
Also, check for absolute paths first, findAllResources(res, "/absolute/path") returned the path, QStandardPaths doesn't.

An easy case is KStandardDirs::findExe -&gt; QStandardPaths::findExecutable. Well, not so easy: it doesn't support looking into "libexec" at this point. To be resolved.
</li>
<li>KConfig has been ported to QStandardPaths. This changes the "const char* resourceType" in the API into QStandardPaths::StandardLocation, and means that modifying the "config" resource before using KConfig has no effect on KConfig anymore.
</li>
<li>KTemporaryFile is deprecated, port to QTemporaryFile instead, see KTemporaryFile API documentation for details.</li>
<li>KTempDir is deprecated, port to QTemporaryDir instead, see KTempDir API documentation for details.</li>
<li>KMD5 is deprecated, port to QCryptographicHash instead.</li>
<li>KMimeType is deprecated, port to QMimeType instead. Here's a porting guide:
<pre>
   QMimeDatabase db; // All the methods need a db instance, but it's very cheap to create, on stack is fine.
   KMimeType::Ptr mime -&gt; QMimeType mime
   if (mime) -&gt; if (mime.isValid())
   KMimeType::mimeType(name) -&gt; db.mimeTypeForName(name)
   KMimeType::mimeType(name, DontResolveAlias) -&gt; db.mimeTypeForName(name) // there is no separate mime object for the alias
   KMimeType::findByUrl(url) -&gt; db.mimeTypeForUrl(url)
   KMimeType::findByPath(path) -&gt; db.mimeTypeForFile(path)
   KMimeType::findByPath(path, 0, true) -&gt; db.mimeTypeForFile(path, QMimeDatabase::MatchExtension)
       (this is slightly different in case of conflicting globs though, findByPath used to return empty,
        so that delayed mimetype determination could then refine this; mimeTypesForFileName can be useful
        to detect this case. But for most applications this detail doesn't matter).
   KMimeType::findByContent(data) -&gt; db.mimeTypeForData(data)
   KMimeType::findByNameAndContent(name, data_or_device) -&gt; db.mimeTypeForNameAndData(name, data_or_device)
   KMimeType::findByFileContent(path) -&gt; db.mimeTypeForFile(path, QMimeDatabase::MatchContent)
   mime->name() == KMimeType::defaultMimeType() -&gt; mime.isDefault()
   mime.allParentMimeTypes() -&gt; mime.allAncestors()
   KMimeType::extractKnownExtension(fileName) -&gt; db.suffixForFileName(fileName)
   KMimeType::iconNameForUrl(url) has additional logic on top of db.mimeTypeForUrl(url).iconName(), to
      fallback to the protocol-specific icon (e.g. trash icon for trash:/, etc.). This logic has now
     moved to KIO::iconNameForUrl.
</ul>

<h4 align="right"><a href="#TOC">Return to the Table of Contents</a></h4>


<h3><a name="kdeui">Changes in kdeui</a></h3>

<ul>
<li>KIntValidator: Use QIntValidator instead, the only difference was that KIntValidator attempted to
  support non-decimal bases (but it was broken with prefix and suffix texts, and therefore unused in KDE SC)</li>
<li>KDoubleValidator: Use QDoubleValidator instead (as part of KLocale -&gt; QLocale)</li>
<li>KFloatValidator: Use QDoubleValidator instead (drop-in replacement)</li>
<li>KSvgRenderer: Use QSvgRenderer instead (drop-in replacement)</li>
<li>KCursor: Use QCursor instead</li>
<li>Proxy models: Moved to libitemmodels</li>
</ul>

<h4 align="right"><a href="#TOC">Return to the Table of Contents</a></h4>

<h3><a name="kio">Changes in kio</a></h3>

<ul>
  <li>The KFileItem API has been ported to QMimeType. As a consequence, mimeTypePtr() is now currentMimeType().</li>
</ul>

<h4 align="right"><a href="#TOC">Return to the Table of Contents</a></h4>

<h3><a name="kparts">Changes in kparts</a></h3>

<ul>
  <li>With the port from KUrl to QUrl in APIs, the signature of the virtual method openUrl has changed, make sure
      to port your reimplemented methods to QUrl!</li>
</ul>

<h4 align="right"><a href="#TOC">Return to the Table of Contents</a></h4>


<h3><a name="libkarchive">Changes in libkarchive</a></h3>

<ul>
    <li> KFilterBase::findFilterByFileName and KFilterBase::findFilterByMimeType are gone, now you should use KCompressionDevice::filterForCompressionType
    <li> To get the CompressionType you can call KFilterDev::compressionTypeForMimeType
    <li> KFilterDev::device is deprecated, instead you should use :
    <pre>
        KCompressionDevice::CompressionType type = KFilterDev::compressionTypeForMimeType(mimeType);
        KCompressionDevice flt(&amp;file, false, type);
    </pre>
    <li> KFilterDev::deviceForFile is deprecated, instead you should use :
    <pre>
        KFilterDev dev(fileName)
    </pre>
</ul>

<h4 align="right"><a href="#TOC">Return to the Table of Contents</a></h4>

</body>
</html>
