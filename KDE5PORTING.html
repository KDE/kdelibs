<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Guide to Porting Applications to KDE Frameworks 5</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
<!--
body {
    font-size: 0.8em;
    font-family: "Bitstream Vera Sans", "Lucida Grande", "Trebuchet MS", sans-serif;
    color: #535353;
    background-color: #ffffff;
}

h1, h2, h3, h4, h5 {
    font-weight: bold;
    color: #f7800a;
}

a:link {
    padding-bottom: 0;
    text-decoration: none;
    color: #0057ae;
}

a:visited {
    padding-bottom: 0;
    text-decoration: none;
    color: #644A9B;
}

a[href]:hover {
    text-decoration: underline;
}

pre {
    display: block;
    margin: 0.3em;
    padding: 0.3em;
    font-size: 1em;
    font-family: Courier, 'Courier New', 'Andale Mono', Monaco, monospace;
    color: #000000;
    background: #f9f9f9;
    border: #2f6fab dashed;
    border-width: 1px;
    overflow: auto;
    line-height: 1.1em;
}
-->
</style>
</head>
<body>
<h1>Porting Applications to KDE Frameworks 5</h1>

<h2>Note</h2>

<p>This document contains the changes you have to apply to programs written for
KDE 4.x when you want to port them to KDE Frameworks 5.<br>

<h3><a name="TOC">Table of Contents</a></h3>

<UL>
<li><a href="#globalchanges">Global Changes</a></li>
<li><a href="#kdecore">Changes in kdecore</a></li>
<li><a href="#kdeui">Changes in kdeui</a></li>
<li><a href="#kio">Changes in kio</a></li>
<li><a href="#kparts">Changes in kparts</a></li>
</UL>

<h3><a name="globalchanges">Global Changes</a></h3>
<ul>
</ul>

<h4 align="right"><a href="#TOC">Return to the Table of Contents</a></h4>


<h3><a name="kdecore">Changes in kdecore</a></h3>

<ul>
<li>kdecore has been split up into a number of independent libraries: libkarchive, libkauth, libkdbus, etc.</li>
<li>KUrl has been deprecated in favour of QUrl. Warning, look at the KUrl documentation for proper porting.
Do not just do a global search and replace, KUrl(QString) means "absolute local file or absolute url" while
QUrl(QString) means "relative url or absolute url". And KUrl::path() is not exactly the same as QUrl::path(), etc.
And in particular KUrl::isParentOf means "parent or equal" while QUrl::isParentOf is strictly "parent" (use QUrlPathInfo::isParentOfOrEqual instead).
<li>KUrl::upUrl is now the static method KIO::upUrl</li>
<li>For the reason above, many signals with a KUrl have been replaced with a QUrl:
<pre>
    KUrlRequester: urlSelected(const KUrl&amp;) &gt; urlSelected(const QUrl&amp;)
    KRecentFilesAction: urlSelected(const KUrl&amp;) &gt; urlSelected(const QUrl&amp;)
    KUrlComboBox: urlActivated(const KUrl&amp;) &gt; urlActivated(const QUrl&amp;)
    KPropertiesDialog: saveAs(KUrl,KUrl) &gt; saveAs(QUrl,QUrl)
</pre>
Remember to update your connect statements and your slots!
<li>KMimeType::comment and KMimeType::iconName no longer take a KUrl argument. If you were passing such an argument
(to support .directory files in directories), port the code to KFileItem::mimeComment and KFileItem::iconName.</li>
<li>KSaveFile has been deprecated in favour of the new QSaveFile:
<pre>
     open() -&gt; open(QIODevice::WriteOnly)
     finalize() -&gt; commit()
     abort() -&gt; cancelWriting()
     close() -&gt; do not call close, call commit or cancelWriting directly
     the return value from write() calls does not need to be checked anymore, commit will cancel in case of a write error.
</pre>
<li>KComponentData:
<ul>
    <li>dirs() has been removed. Use KGlobal::dirs() instead.
    The only difference (for other KComponentData instances than the main one),
    is the "appdata" resource, which would now point to the application name
    rather than the component name. It's cleaner to use "data" anyway (or QStandardPaths::GenericDataLocation),
    and prepend the component name to the searched file.</li>
</ul>
<li>KStandardDirs: KDE applications can keep using it, but independent frameworks should use QStandardPaths instead.
The porting depends on the resource type:
<pre>
    KStandardDirs "data" -&gt; QStandardPaths::GenericDataLocation
    KStandardDirs "appdata" -&gt; QStandardPaths::DataLocation
    KStandardDirs "config" -&gt; QStandardPaths::ConfigLocation
    KStandardDirs "xdgdata-apps" -&gt; QStandardPaths::ApplicationsLocation
    KStandardDirs "cache" -&gt; QStandardPaths::GenericCacheLocation
    KStandardDirs "socket" -&gt; QStandardPaths::RuntimeLocation
</pre>
If the resource is available in QStandardPaths (i.e. for all of the above), then the porting is simple:
<pre>
    KStandardDirs::locate("data", "kmyapp/my-data") -&gt; QStandardPaths::locate(QStandardPaths::GenericDataLocation, "kmyapp/my-data")
    KStandardDirs::locate("services", "foo.desktop") -&gt; QStandardPaths::locate(QStandardPaths::GenericDataLocation, "kde5/services/foo.desktop")
    dirs.findResource("data", relPath -&gt; QStandardPaths::locate(QStandardPaths::GenericDataLocation, "kmyapp/my-data")
    dirs.findDirs("data", "kconf_update") -&gt; QStandardPaths::locateAll(QStandardPaths::GenericDataLocation, "kconf_update", QStandardPaths::LocateDirectory)
    saveLocation -&gt; writableLocation (note that you might have to mkpath it if it doesn't exist)
    locateLocal(type, file) -&gt; writableLocation(type) + '/' + file (you might have to mkpath the directory)
    resourceDirs("xdgdata-apps") -&gt; QStandardPaths::standardLocations(QStandardPaths::ApplicationsLocation)  (no trailing slashes anymore though)
</pre>
Otherwise, you need to use GenericDataLocation and add the subdirectory name manually.
<pre>
    dirs()-&gt;resourceDirs("xdgdata-icon") -&gt; QStandardPaths::locateAll(QStandardPaths::GenericDataLocation, "icons", QStandardPaths::LocateDirectory) // xdgata-icon is the "icons" subdir under the xdg data locations
    dirs()-&gt;findAllResources("xdgdata-mime", file) -&gt; QStandardPaths::locateAll(QStandardPaths::GenericDataLocation, "mime/" + file)
    Similarly, xdgconf-menu is QStandardPaths::ConfigLocation + "menus", and xdgconf-autostart is QStandardPaths::ConfigLocation + "autostart";
    "xdgdata-dirs" is QStandardPaths::GenericDataLocation + "desktop-directories"
    "templates" is QStandardPaths::GenericDataLocation + "templates"
    "emoticons" is QStandardPaths::GenericDataLocation + "emoticons
    "html" is QStandardPaths::GenericDataLocation + "doc/HTML"
    "sound" is QStandardPaths::GenericDataLocation + "sounds" (note the additional 's')
    "wallpaper" is QStandardPaths::GenericDataLocation + "wallpapers" (note the additional 's')
    (see kstandarddirs.cpp line 119 ff for resources that are missing here)
</pre>
When the code uses wildcard filters or the Recursive flag in findAllResources, you cannot port it to one line of QStandardPaths.
Either keep using KStandardDirs, or write your own filtering (QDir::entryList) or recursive listing (use QDirIterator with the Subdirectories flag).
Also, check for absolute paths first, findAllResources(res, "/absolute/path") returned the path, QStandardPaths doesn't.
<br/>
If NoDuplicates was used, make a unique list of relative paths first, then use locate on each one (see autostart.cpp for an example).
<br/>
Example using entryList:
<pre>
    QStringList files = dirs()-&gt;findAllResources("data", "foo/bar/*.desktop")
becomes:
    QStringList files;
    const QStringList dirs = QStandardPaths::locateAll(QStandardPaths::GenericDataLocation, "foo/bar", QStandardPaths::LocateDirectory);
    Q_FOREACH (const QString&amp; dir, dirs) {
        Q_FOREACH (const QString&amp; file, QDir(dir).entryList(QStringList() &lt;&lt; QStringLiteral("*.desktop"))) {
            files.append(dir + '/' + file);
        }
    }
</pre>
Example using QDirIterator:
<pre>
    QStringList files;
    const QStringList dirs = QStandardPaths::locateAll(QStandardPaths::GenericDataLocation, "foo/bar", QStandardPaths::LocateDirectory);
    Q_FOREACH (const QString&amp; dir, dirs) {
        QDirIterator it(dir, QStringList() &lt;&lt; QStringLiteral("*.desktop"));
        while (it.hasNext()) {
            files.append(it.next());
        }
    }
</pre>
On the other hand, findAllResources("locale", "*/entry.desktop") requires
<pre>
    const QStringList localeDirs = QStandardPaths::locateAll(QStandardPaths::GenericDataLocation, QStringLiteral("locale"), QStandardPaths::LocateDirectory);
    Q_FOREACH (const QString&amp; localeDir, localeDirs) {
        const QStringList entries = QDir(localeDir).entryList(QDir::Dirs);
        Q_FOREACH (const QString&amp; d, entries) {
            if (QFile::exists(localeDir + '/' + d + "/entry.desktop")) {
                // ...
            }
        }
    }
</pre>
KStandardDirs::findExe (and the use of the "exe" resource) can be ported to QStandardPaths::findExecutable, except when the executable comes from libexec, in which case the path should just be hardcoded using CMAKE_INSTALL_PREFIX "/" LIBEXEC_INSTALL_DIR.

The "lib" resource was not used directly in code (the linker finds shared libs, not the code).

The "module" resource, on the other hand, was used to locate plugins. KPluginLoader now uses QT_PLUGIN_PATH instead, and looks in the kf5 subdirectory.
Please email kde-frameworks-devel@kde.org if you would need public API for this.

A script is available in kdesdk/kde-dev-scripts/kf5/convert-kstandarddirs.pl to port some of this.
</li>
<li>KConfig and KDesktopFile have been ported to QStandardPaths. This changes the "const char* resourceType" in the API into QStandardPaths::StandardLocation, and means that modifying the "config" resource before using KConfig has no effect on KConfig anymore.
</li>
<li>KConfigBase::sync now returns a bool</li>
<li>KCoreConfigSkeleton::writeConfig now returns a bool</li>
<li>KCoreConfigSkeleton::usrWriteConfig now returns a bool</li>
<li>KTemporaryFile is deprecated, port to QTemporaryFile instead, see KTemporaryFile API documentation for details.</li>
<li>KTempDir is deprecated, port to QTemporaryDir instead, see KTempDir API documentation for details.</li>
<li>KToolInvocation::invokeHelp is now KHelpClient::invokeHelp, in the kwidgets framework.</li>
<li>KMD5 is deprecated, port to QCryptographicHash instead.</li>
<li>KMimeType is deprecated, port to QMimeType instead. Here's a porting guide:
<pre>
   QMimeDatabase db; // All the methods need a db instance, but it's very cheap to create, on stack is fine.
   KMimeType::Ptr mime -&gt; QMimeType mime
   if (mime) -&gt; if (mime.isValid())
   KMimeType::mimeType(name) -&gt; db.mimeTypeForName(name)
   KMimeType::mimeType(name, DontResolveAlias) -&gt; db.mimeTypeForName(name) // there is no separate mime object for the alias
   KMimeType::findByUrl(url) -&gt; db.mimeTypeForUrl(url)
   KMimeType::findByUrl(url, 0, is_local, true) -&gt; db.mimeTypeForFile(url.path(), QMimeDatabase::MatchExtension)
   KMimeType::findByPath(path) -&gt; db.mimeTypeForFile(path)
   KMimeType::findByPath(path, 0, true) -&gt; db.mimeTypeForFile(path, QMimeDatabase::MatchExtension)
       (this is slightly different in case of conflicting globs though, findByPath used to return empty,
        so that delayed mimetype determination could then refine this; mimeTypesForFileName can be useful
        to detect this case. But for most applications this detail doesn't matter).
   KMimeType::findByContent(data) -&gt; db.mimeTypeForData(data)
   KMimeType::findByNameAndContent(name, data_or_device) -&gt; db.mimeTypeForNameAndData(name, data_or_device)
   KMimeType::findByFileContent(path) -&gt; db.mimeTypeForFile(path, QMimeDatabase::MatchContent)
   mime-&gt;name() == KMimeType::defaultMimeType() -&gt; mime.isDefault()
   mime.allParentMimeTypes() -&gt; mime.allAncestors()
   KMimeType::extractKnownExtension(fileName) -&gt; db.suffixForFileName(fileName)
   KMimeType::iconNameForUrl(url) has additional logic on top of db.mimeTypeForUrl(url).iconName(), to
      fallback to the protocol-specific icon (e.g. trash icon for trash:/, etc.). This logic has now
     moved to KIO::iconNameForUrl.
   KMimeType::patterns() -&gt; QMimeType::globPatterns()
   KMimeType::allMimeTypes() -&gt; db.allMimeTypes()
</pre>
</li>
<li>KLocale has been splitted up: KLocale is now only about locale settings, while translation support has moved to KLocalizedString.
<pre>
    KLocale::insertCatalog -&gt; KLocalizedString::insertCatalog
</pre>
</li>
<li>KCmdLineArgs uses K4AboutData rather than KAboutData: K4AboutData keeps the old mechanism for delayed translations
 (I18N_NOOP), while KAboutData is the one used by plugins, which can use immediate translation (i18n).
</li>
<li>KEncodingDetector is removed, port to KEncodingProber. Porting guide:
<pre>
    KEncodingDetector detector -&gt; KEncodingProber prober
    enum KEncodingDetector::AutoDetectScript -&gt; enum KEncodingProber::ProberType
    detector.encoding() -&gt; prober.encoding()
    detector.visuallyOrdered() -&gt; check prober.encoding() hebrew
    detector.autoDetectLanguage() -&gt; prober.proberType()
    detector.setAutoDetectLanguage(script) -&gt; prober.setProberType(proberType)
    detector.decode(data) -&gt; prober.feed(data) + QTextCodec::codecForName(prober.encoding())->toUnicode(data)
    detector.decodeWithBuffering(data, len) -&gt; prober.feed(data1), feed(data2), feed(data3) + check prober.state() + QTextCodec::codecForName(prober.encoding())-&gt;makeDecoder()
    detector.decodedInvalidCharacters() -&gt; QTextCodec::codecForName(prober.encoding())-&gt;makeDecoder() + hasFailure()
    detector.resetDecoder() -&gt; prober.reset()
    detector.flush() -&gt; prober.feed(data1), feed(data2), feed(data3) + QTextCodec::codecForName(prober.encoding())->toUnicode
    KEncodingDetector::scriptForName(lang) -&gt; KEncodingProber::proberTypeForName(lang)
    KEncodingDetector::nameForScript(script) -&gt; KEncodingProber::nameForProberType(proberType)
    KEncodingDetector::hasAutoDetectionForScript(script) -&gt; if (proberType == KEncodingProber::None) ... else ...
    KEncodingProber::encodingName() is removed, use KEncodingProber::encoding() instead.
</pre>
    The following functions have been moved into khtml with the orignal KEncodingDetector class. khtml is the only user of them.
<pre>
    enum KEncodingDetector::EncodingChoiceSource -&gt; removed
    KEncodingDetector::setEncoding(encoding, choice) -&gt; removed, implement it in khtml code
    KEncodingDetector::encodingChoiceSource() -&gt; removed
</pre>
</li>
<li>qtest_kde.h is deprecated. Port to &lt;QtTest&gt;, for core tests, or to &lt;QtTestWidgets&gt; for tests that use widgets, otherwise they'll crash in code that requires QApplication internally.</li>
</ul>

<h4 align="right"><a href="#TOC">Return to the Table of Contents</a></h4>


<h3><a name="kdeui">Changes in kdeui</a></h3>

<ul>
<li>KApplication/KUniqueApplication: use QApplication instead, but make sure to:
   <ul>
   <li>Call QCoreApplication::setApplicationName("...")</li>
   <li>Call QCoreApplication::setApplicationVersion("...") (from the old KAboutData object)</li>
   <li>Call QCoreApplication::setOrganizationDomain("kde.org")</li>
   <li>Call QApplication::setApplicationDisplayName(i18n("...")) for GUI programs</li>
   <li>Use KDBusService for DBus registration, and optional "unique" behavior</li>
   </ul>
</li>
<li>KIntValidator: Use QIntValidator instead, the only difference was that KIntValidator attempted to
  support non-decimal bases (but it was broken with prefix and suffix texts, and therefore unused in KDE SC)</li>
<li>KDoubleValidator: Use QDoubleValidator instead (as part of KLocale -&gt; QLocale)</li>
<li>KFloatValidator: Use QDoubleValidator instead (drop-in replacement)</li>
<li>KSvgRenderer: Use QSvgRenderer instead (drop-in replacement)</li>
<li>KCursor: Use QCursor instead</li>
<li>KIdentityProxyModel: Removed, used QIdentityProxyModel instead (trivial search/replace)</li>
<li>Other proxy models: Moved to libitemmodels</li>
<li>KPassivePopup: standardView() now returns a QWidget* instead of a KVBox*. The QWidget has a QVBoxLayout, i.e., additional widgets can be appended by calling widget-&gt;layout()-&gt;addWidget().</li>
<li>KCodecAction: use enum KEncodingProber::ProberType instead of enum KEncodingDetector::AutoDetectScript</li>
<li>KXMessages: the "obsolete = false" argument has been removed from all methods, and int screen has a default value of -1 now. Remove the "-1, false" in all calls. The sendMessage and sendMessageX methods were apparently unused, and have been commented out. Email kde-frameworks-devel at kde.org if you need them back.</li>
<li>KGlobalSettings::contextMenuKey is gone, reimplement QWidget::contextMenuEvent() instead.</li>
<li>KGlobalSettings::*Font methods are deprecated. Use QFontsDatabase::systemFonts(). ::menuFont, ::taskBarFont and ::toolBarFont are not available now (they are provided by the QPA but not public API). If cases needing those arise we'll
have to find an alternative</li>
<li>KMessageBox is no longer a class, but a namespace, as it only had static methods. The KMessageBox namespace spans now in three frameworks:
    <ul>
    <li>WId methods are now in kmessagebox_kiw.h from kinterprocesswindowing framework</li>
    <li>Queued methds are now in kmessagebox_queued.h from kde4support framework</li>
    <li>The remainder of the methods are now in kmessagebox.h from kwidgets
        <ul>
            <li>setDontShowAskAgainConfig was renamed to setDontShowAgainConfig</li>
            <li>NOTE1: KMessageBox no longer uses notifications</li>
            <li>NOTE2: Too long messages no longer trigger KSqueezedTextLabel usage. This is a temporary measure, though, to avoid dependencies on kdeui.</li>
        </ul>
    </li>
    </ul>
</li>
<li>KMessageBoxMessageHandler moved to kde4support</li>
<li>KNotification: setComponentData(KComponentData) is now setComponentName(QString), only the component name was used.</li>
<li>KActionCollection and KXMLGUIClient: replace setComponentData with setComponentName and setComponentDisplayName</li>
<li>KAction changes
    <ul>
        <li>Shape and rocker gestures are now handled by KGestureMap. The existing KAction methods related to gesture handling delegate to KGestureMap.</li>
    </ul>
</li>
<li>KGestureMap changes:
    <ul>
        <li><b>addGesture</b> renamed to <b>setShapeGesture</b> and <b>setRockerGesture</b> and now allow replacing existing gestures. When this occurs, a warning is traced with qDebug.</li>
        <li>new <b>setDefault[Shape|Rocker]Gesture</b> methods allow defining default gestures for an action, providing the functionality removed from KAction.</li>
        <li>new <b>shapeGesture</b> and <b>defaultShapeGesture</b> methods retrieves already defined shape gestures for a given action</li>
        <li>new <b>rockerGesture</b> and <b>defaultRockerGesture</b> methods retrieves already defined rocker gestures for a given action</li>
    </ul>
</li>
<li>KAction global shortcut handling logic moved to KGlobalAccel. So the KAction::globalShortcutChanged signal was removed and a new corresponding KGlobalAccel::globalShortcutChanged has been added. The signal semantics have not changed.
</li>
<li>KUndoStack: Use QUndoStack with KUndoActions::createUndoAction() and KUndoActions::createRedoAction() instead</li>
<li>KRichTextWidget: createActions() does not take any KActionCollection and returns a list of QAction instead. You could use KActionCollection.addActions(KRichTextWidget.createActions()) instead.</li>
<li>KTextBrowser: Use QTextBrowser instead. The only difference is QTextBrowser does not support "whatsthis:" urls.</li>
</ul>

<h4 align="right"><a href="#TOC">Return to the Table of Contents</a></h4>

<h3><a name="kio">Changes in kio</a></h3>

<ul>
  <li>The very common job-&gt;ui()-&gt;setWindow(widget) has to be ported to KJobWidgets::setWindow(job, widget), because job-&gt;ui() is now only a KJobUiDelegate.</li>
  <li>The deprecated KIO::Job::showErrorDialog() has been removed, use KJobWidgets::setWindow(job, parent) and job-&gt;ui()-&gt;showErrorMessage()
  <li>The KFileItem API has been ported to QMimeType. As a consequence, mimeTypePtr() is now currentMimeType().</li>
  <li>KFileItem::run(QWidget*) has disappeared, due to core/gui separation. Use new KRun(item.targetUrl(), widget) instead.</li>
  <li>KFileItem::pixmap(size, state=0) has disappeared, due to core/gui separation. If you can, use KIcon(item.iconName(), 0, item.overlays()) instead.
   If you really need a QPixmap, e.g. for showing in a QLabel, use this instead:
  <pre>
    KIconLoader::global()-&gt;loadMimeTypeIcon(item.iconName(), KIconLoader::Desktop, size, state);
  </pre>

  <li>KIO::pixmapForUrl has moved from kio/global.h to kio/pixmaploader.h (so that global.h is core only)</li>
  <li>KProtocolInfo::isHelperProtocol() and exec() no longer detect apps associated with x-scheme-handler/*. This has moved up to KRun. Therefore KProtocolInfo is again about .protocol files only.</li>
  <li>KIO::RenameDialogPlugin was removed, it was unused for a long time anyway. The rename dialog uses KFileMetaDataWidget and PreviewJob instead.</li>
  <li>When Job::setUiDelegate(0) is used on a CopyJob (KIO::copy or KIO::move), an extra call to setUiDelegateExtension(0) is probably necessary, to disable skip and rename dialogs.</li>
  <li>KIO::Job::isInteractive() has been removed, use uiDelegate() or uiDelegateExtension() depending on what is meant (error messages, or rename/skip dialog).</li>
</ul>

<h4 align="right"><a href="#TOC">Return to the Table of Contents</a></h4>

<h3><a name="kparts">Changes in kparts</a></h3>

<ul>
  <li>With the port from KUrl to QUrl in APIs, the signature of the virtual method openUrl has changed, make sure
      to port your reimplemented methods to QUrl!</li>
</ul>

<h4 align="right"><a href="#TOC">Return to the Table of Contents</a></h4>


<h3><a name="libkarchive">Changes in libkarchive</a></h3>

<ul>
    <li> KFilterBase::findFilterByFileName and KFilterBase::findFilterByMimeType are gone, now you should use KCompressionDevice::filterForCompressionType
    <li> To get the CompressionType you can call KFilterDev::compressionTypeForMimeType
    <li> KFilterDev::device is deprecated, instead you should use :
    <pre>
        KCompressionDevice::CompressionType type = KFilterDev::compressionTypeForMimeType(mimeType);
        KCompressionDevice flt(&amp;file, false, type);
    </pre>
    <li> KFilterDev::deviceForFile is deprecated, instead you should use :
    <pre>
        KFilterDev dev(fileName)
    </pre>
</ul>

<h4 align="right"><a href="#TOC">Return to the Table of Contents</a></h4>

</body>
</html>
