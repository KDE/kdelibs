#!/usr/bin/make -f
# Sample debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess.

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This is the debhelper compatability version to use.
export DH_COMPAT=3

QTDOCDIR  = usr/share/doc/qt-doc/doc/html
KDEDOCDIR = usr/share/doc/kdelibs-doc/html
KDEDEVDIR = usr/share/doc/kdelibs-dev

ARCH = $(shell dpkg-architecture -qDEB_BUILD_ARCH)
ifeq ($(ARCH),alpha)
	export CFLAGS=-O0 -mieee
	export CXXFLAGS=-O0 -mieee
endif

ifeq ($(ARCH),i386)
	# Uncomment the following 2 lines to enable i686 optimziation
	# You may want to tweak the settings to your likings
	#export CFLAGS=-O3 -march=i686 -ffast-math -finline-functions
	#export CXXFLAGS=-O3 -march=i686 -ffast-math -finline-functions
	XINERAMA=--with-xinerama
endif

version=`head -1 debian/changelog | sed -e "s#.*(\([^)]*\)).*#Debian Package \1#"`

-include debian/debiandirs

debian/debiandirs: admin/debianrules
	perl -w admin/debianrules echodirs > debian/debiandirs

configure: configure-stamp
configure-stamp:
	dh_testdir

	# Apply Debian specific patches
	if test ! -f patch-stamp; then \
		cat debian/patches/*.diff | patch -p1;\
		touch patch-stamp;\
	fi

	# KDE CVS does not have aclocal.m4 or configure
	if test ! -f configure; then \
		$(MAKE) -f admin/Makefile.common ;\
	fi

	./configure $(configkde) \
	--with-distribution="$$version (`cat /etc/debian_version`)" \
	--enable-final --enable-fast-install --with-alsa $(XINERAMA)

	touch configure-stamp

build: build-stamp
build-stamp: configure-stamp 
	dh_testdir

	# Add here commands to compile the package.
	$(MAKE)

	touch build-stamp

clean:
	dh_testdir
	dh_testroot
	-rm -f build-stamp configure-stamp debian/debiandirs

	# Remove Debian specific patches
	if test -f patch-stamp; then \
		cat debian/patches/*.diff | patch -p1 -R;\
		rm -f patch-stamp;\
	fi

	# Add here commands to clean up after the build process.
	-$(MAKE) distclean

	if test -d CVS; then \
		$(MAKE) -f admin/Makefile.common cvs-clean ;\
	fi

	dh_clean

install-arch: build
	dh_testdir
	dh_testroot
	dh_clean -k -a
	dh_installdirs -a

	# Add here commands to install the package into debian/tmp
	$(MAKE) install DESTDIR=$(CURDIR)/debian/tmp

	# Install dh-make template for KDE packages
	install -d debian/tmp/$(KDEDEVDIR)/dh-make
	install -p debian/dh-make/*           debian/tmp/$(KDEDEVDIR)/dh-make
	install -p admin/debianrules          debian/tmp/$(KDEDEVDIR)/dh-make

	# make artswrapper suidroot
	-chmod 4755 debian/tmp/usr/bin/artswrapper

	# make proxytype.pl and useragent.pl executable
	-chmod 755 debian/tmp/usr/share/apps/kconf_update/useragent.pl \
		   debian/tmp/usr/share/apps/kconf_update/proxytype.pl

	# Create system.kdeglobals file with paths from admin/debianrules
	debianrc=debian/tmp/etc/kde2/system.kdeglobals ;\
	echo "[Directories]"				> $$debianrc ;\
	echo "dir_config=$$kde_confdir"			>> $$debianrc ;\
	echo "dir_tmp=/tmp"				>> $$debianrc ;\
	echo "dir_socket=/tmp"				>> $$debianrc ;\
	echo "dir_exe=$$kde_bindir"			>> $$debianrc ;\
	echo "dir_lib=$$kde_libdir"			>> $$debianrc ;\
	echo "dir_cgi=$$kde_cgidir"			>> $$debianrc ;\
	echo "dir_module=$$kde_moduledir"		>> $$debianrc ;\
	echo "dir_apps=$$kde_appsdir"			>> $$debianrc ;\
	echo "dir_data=$$kde_datadir"			>> $$debianrc ;\
	echo "dir_html=$$kde_htmldir"			>> $$debianrc ;\
	echo "dir_icon=$$kde_icondir"			>> $$debianrc ;\
	echo "dir_locale=$$kde_locale"			>> $$debianrc ;\
	echo "dir_mime=$$kde_mimedir"			>> $$debianrc ;\
	echo "dir_services=$$kde_servicesdir"		>> $$debianrc ;\
	echo "dir_servicetypes=$$kde_servicetypesdir"	>> $$debianrc ;\
	echo "dir_sound=$$kde_sounddir"			>> $$debianrc ;\
	echo "dir_templates=$$kde_templatesdir"		>> $$debianrc ;\
	echo "dir_wallpaper=$$kde_wallpaperdir"		>> $$debianrc ;\
	echo "[General]"				>> $$debianrc ;\
	echo "TerminalApplication=x-terminal-emulator"	>> $$debianrc

install-indep: configure
	dh_testdir
	dh_testroot
	dh_clean -k -i
	dh_installdirs -i

	# Make directory for kdoc
	install -d debian/tmp/$(KDEDOCDIR)/kdoc-reference

	# Makes Qt2 library cross-reference
	qt2kdoc \
	--url=/$(QTDOCDIR) \
	--outdir=$(CURDIR)/debian/tmp/$(KDEDOCDIR)/kdoc-reference \
	--compress /$(QTDOCDIR)

	# Makes kdelibs library docs and cross-reference
	makekdedoc \
	--kdocopt='--skip-deprecated --skip-internal --compress' \
	--libdir=$(CURDIR)/debian/tmp/$(KDEDOCDIR)/kdoc-reference \
	--outputdir=$(CURDIR)/debian/tmp/$(KDEDOCDIR) \
	--url=/$(KDEDOCDIR)

	# Install graphics needed for kdeui docs
	install -p doc/api/kcolordialog.png    debian/tmp/$(KDEDOCDIR)/kdeui
	install -p doc/api/kdatepicker.png     debian/tmp/$(KDEDOCDIR)/kdeui
	install -p doc/api/kfontdialog.png     debian/tmp/$(KDEDOCDIR)/kdeui
	install -p doc/api/kpixmapio-perf.png  debian/tmp/$(KDEDOCDIR)/kdeui

	# Install graphics needed for kfile docs
	install -p doc/api/kfiledialog.png     debian/tmp/$(KDEDOCDIR)/kfile

# Build architecture-independent files here.
binary-indep: configure install-indep
	dh_testdir
	dh_testroot
	dh_movefiles -i

	dh_installdocs -i
	dh_installchangelogs -i
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

# Build architecture-dependent files here.
binary-arch: build install-arch
	dh_testdir
	dh_testroot
	dh_movefiles -a

	dh_installdebconf -a
	dh_installdocs -a
	dh_installexamples -a
	dh_installmenu -a
	dh_installpam -a
	dh_installman -a
	dh_undocumented -a
	dh_installchangelogs -a
	dh_link -a
	dh_strip -a
	dh_compress -a
	dh_fixperms -a -X artswrapper
	dh_makeshlibs -a -V
	dh_installdeb -a
	dh_perl -a
	dh_shlibdeps -a -ldebian/kdelibs3/usr/lib:debian/libarts/usr/lib:debian/libarts-kde/usr/lib
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install install-indep configure
